# Epic 2 Retrospective: Coupon Lifecycle Management

**Date:** 2026-01-11
**Facilitator:** Bob (Scrum Master)
**Epic Status:** Complete (3/3 stories)

## Team Participants

- Bob (Scrum Master) - Facilitator
- Alice (Product Owner)
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- Hafiz (Project Lead)

## Epic Summary

**Epic 2: Coupon Lifecycle Management**

API consumer can create coupons and retrieve their full details including stock levels and claim history.

### Delivery Metrics

| Metric | Value |
|--------|-------|
| Stories Completed | 3/3 (100%) |
| Issues Found in Review | 9 total (4 HIGH, 5 MEDIUM) |
| Technical Debt Items | 2 LOW (deferred) |
| Test Coverage | service 100%, handler 87%, repository 89-94% |
| Production Incidents | 0 |

### Stories Completed

1. **Story 2.1: Create Coupon Endpoint** - Done
   - Issues fixed: 3 HIGH (missing integration tests, 0% repo coverage, missing test file), 2 MEDIUM
   - Key learning: Used `*int` pointer for Amount to distinguish missing vs zero

2. **Story 2.2: Get Coupon Details Endpoint** - Done
   - Issues fixed: 1 HIGH (missing empty name validation), 3 MEDIUM
   - Key learning: Return empty array `[]` not null for claimed_by

3. **Story 2.3: OpenAPI Specification for Coupon Endpoints** - Done
   - Documentation-only story
   - Added 500 responses and format:int32 during review

## What Went Well

### Successes Identified

1. **100% story completion** with all acceptance criteria met
2. **Adversarial code review with ultrathink mentality** caught 4 HIGH severity issues
3. **Excellent test coverage** (87-100%) - tests written alongside code
4. **Layered architecture pattern** established and consistent (Handler → Service → Repository)
5. **Interface-based design** (ClaimRepository, PoolInterface) enables testability
6. **Epic 1 action items applied** - tests now written alongside implementation
7. **Pointer trick for validation** (`*int` for Amount) solved missing vs zero distinction
8. **5 SQL injection tests** added during Story 2-1 review

## What Didn't Go Well

### Challenges Identified

1. **Repository nil, nil pattern** is non-obvious for error handling
   - Returns `nil, nil` when not found - caller must check both values

2. **Handler coverage at 87%** - 500 error paths hard to trigger in unit tests

3. **Validation edge case uncertainty** - empty string coupon name needs verification

4. **Epic 3 introduces new patterns** - transaction management not yet used in codebase

## Key Insights

1. **Ultrathink sessions are valuable** - deep critical analysis catches issues that surface-level review misses
2. **Code review catches real bugs** - 4 HIGH issues would have caused production problems
3. **Tests alongside code is now habit** - coverage improved from Epic 1
4. **Patterns compound** - Epic 1 patterns (interface-based design) made Epic 2 easier
5. **Transaction patterns analyzed proactively** - team understands Epic 3 requirements before starting

## Previous Epic Action Item Follow-Through

### From Epic 1 Retrospective

| Action Item | Status | Evidence |
|-------------|--------|----------|
| Add path/dependency validation step before implementation | ⏳ Partial | Fewer path issues, but some still caught in review |
| Write tests alongside implementation, not after | ✅ Applied | Coverage 87-100%, tests in same commits as code |

### Team Agreements from Epic 1 (All Continued)

- ✅ Continue adversarial code review for every story
- ✅ Use interface patterns for testability

## Ultrathink Analysis: Epic 3 Readiness

### Transaction Pattern Required

```
CLAIM TRANSACTION FLOW (Must be ATOMIC)
1. BEGIN TRANSACTION
2. SELECT * FROM coupons WHERE name = $1 FOR UPDATE  ← ROW LOCK
3. IF remaining_amount = 0 → ROLLBACK, return "out of stock"
4. INSERT INTO claims (user_id, coupon_name) VALUES ($1,$2)
   └── IF unique violation → ROLLBACK, return "already claimed"
5. UPDATE coupons SET remaining_amount = remaining_amount - 1
6. COMMIT
```

### Key Technical Decisions

- **Service layer owns transactions** - repositories accept `pgx.Tx` parameter
- **`defer tx.Rollback()` pattern** - prevents transaction leaks
- **New sentinel errors needed** - `ErrOutOfStock`, `ErrAlreadyClaimed`
- **Stress tests will validate** - 50 concurrent requests, exactly 5 claims

### Readiness Assessment

| Capability | Status |
|------------|--------|
| `pool.BeginTx()` | ✅ pgx supports it |
| `SELECT FOR UPDATE` | ⚠️ New pattern to implement |
| Unique constraint handling | ✅ Pattern exists from Story 2-1 |
| Transaction-aware repository methods | ⚠️ To be added in Story 3-1 |

## Action Items

### Process Improvements

| # | Action Item | Owner | Deadline | Success Criteria |
|---|-------------|-------|----------|------------------|
| 1 | Continue adversarial code review with ultrathink mentality | All | Ongoing | Every story gets deep critical review |
| 2 | Document `defer tx.Rollback()` pattern in project-context.md | Dev Agent | Before Story 3-1 | Pattern documented for consistency |

### Technical Debt

| # | Item | Owner | Priority | Notes |
|---|------|-------|----------|-------|
| 1 | Verify empty string coupon name is rejected by validator | Dev Agent | High | Quick verification before Epic 3 |
| 2 | Inconsistent interface naming (ClaimPoolInterface vs PoolInterface) | Dev Agent | Low | Cosmetic, defer to Epic 4 |

### Team Agreements

- Continue writing tests alongside implementation
- Use ultrathink analysis for complex technical stories
- Service layer owns transaction logic, repositories accept `pgx.Tx`
- Always use `defer tx.Rollback()` pattern for transaction safety

## Next Epic Preview

**Epic 3: Atomic Claim Processing**

- 3 stories planned
- Goal: API consumer can claim coupons with guaranteed correctness under high concurrency

### Stories

1. **Story 3-1:** Claim Coupon Endpoint with Atomic Transaction
2. **Story 3-2:** Transaction Isolation and Row Locking
3. **Story 3-3:** Complete OpenAPI Specification

### Dependencies on Epic 2 (All Met)

- [x] CouponRepository with GetByName method
- [x] ClaimRepository structure
- [x] Layered architecture pattern established
- [x] Error handling patterns (sentinel errors, HTTP mapping)
- [x] OpenAPI specification foundation

### Preparation Status

**No blocking preparation needed** - Epic 2 delivered everything Epic 3 requires. Transaction patterns will be implemented as part of Epic 3 stories.

## Readiness Assessment

| Area | Status | Notes |
|------|--------|-------|
| Testing & Quality | ✅ Ready | All tests pass, coverage 87-100%, 0 lint issues |
| Deployment | ✅ Ready | docker-compose works, endpoints responding |
| Technical Health | ✅ Ready | Clean codebase, patterns established |
| Blockers | ✅ None | Ready to start Epic 3 immediately |

## Retrospective Outcome

**Epic 2 Status:** COMPLETE - Ready for Epic 3

**Key Achievements:**
- 3 stories delivered with 100% AC coverage
- 9 issues caught and fixed through code review
- Ultrathink sessions provided deep technical analysis
- Team aligned on Epic 3 transaction patterns
- Process improvements from Epic 1 successfully applied

---

*Retrospective facilitated by Bob (Scrum Master)*
*Document generated: 2026-01-11*
