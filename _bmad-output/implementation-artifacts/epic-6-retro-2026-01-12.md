# Epic 6 Retrospective: Advanced Testing & Chaos Engineering

**Date**: 2026-01-12
**Facilitator**: Bob (Scrum Master)
**Participants**: Alice (Product Owner), Bob (Scrum Master), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev), Hafiz (Project Lead)

---

## Epic Summary

| Metric | Value |
|--------|-------|
| Stories Completed | 6/6 (100%) |
| CI Pipeline Time | ~2 mins (Stage 1: ~37-54s, Stage 2: ~53-62s) |
| Test Coverage | 86.1% (exceeds 80% threshold) |
| New CI-Only Tests | 20+ chaos engineering tests |
| Scale Tests | 100/200/500 concurrent (Story 6.1) |
| Production Incidents | 0 |

### Stories Completed
1. 6.1 Scale Stress Tests - Done
2. 6.2 Database Resilience Testing - Done
3. 6.3 Input Boundary Testing - Done
4. 6.4 Transaction Edge Cases - Done
5. 6.5 Mixed Load & Chaos Testing - Done
6.6 Restructure CI Pipeline with Staged Quality Gates - Done

---

## What Went Well

### 1. Staged CI Pipeline
- Stage 1 (unit-tests, lint, security) runs in parallel (~37-54s)
- Stage 2 (integration, stress, chaos) runs after Stage 1 passes (~53-62s)
- Fast feedback on code quality before expensive database tests

### 2. Comprehensive Chaos Testing
- 90+ input boundary test cases across 7 categories
- Database resilience tests (pool exhaustion, query timeout, connection drop)
- Transaction edge case tests (partial failure, deadlock, negative stock)
- Mixed load and chaos tests

### 3. Code Review Pattern
- Adversarial code review caught multiple issues:
  - Test files not committed to git (6.4, 6.5)
  - CI workflow dependencies incorrect
  - String formatting issues (`%d` literal instead of `fmt.Sprintf`)
  - Custom helpers reimplementing stdlib (`contains` vs `strings.Contains`)

---

## What Could Be Improved

### CRITICAL FINDING: Test Architecture Issue

**Problem Identified During Retrospective**:
Tests under `/tests/` were calling service layer functions directly instead of hitting HTTP endpoints.

**Impact**:
- HTTP layer bugs, middleware issues, request parsing bugs could go undetected
- Tests were not testing the full server stack
- Stress tests bypassed the actual HTTP layer

**Files Affected**:
- `tests/stress/flash_sale_test.go` - was calling `couponService.ClaimCoupon()`
- `tests/stress/double_dip_test.go` - was calling service layer
- `tests/stress/scale_test.go` - was calling service layer
- `tests/chaos/mixed_load_test.go` - was calling `svc.ClaimCoupon()`, `svc.Create()`
- `tests/chaos/db_resilience_test.go` - was calling service layer
- `tests/chaos/transaction_edge_cases_test.go` - was calling service layer

### Resolution Applied During Retrospective

All tests refactored to:
1. Use real HTTP endpoints via `net/http` client
2. Connect to docker-compose server (`http://localhost:3000`)
3. Use build tags (`//go:build stress`, `//go:build chaos`, `//go:build integration`)

---

## Action Items from Retrospective

| # | Action Item | Owner | Status |
|---|-------------|-------|--------|
| 1 | Refactor stress tests to use real HTTP | Charlie | ✅ Done |
| 2 | Refactor chaos tests to use real HTTP | Charlie | ✅ Done |
| 3 | Refactor integration tests to use real HTTP | Charlie | ✅ Done |
| 4 | Update CI workflow for docker compose V2 | Charlie | ✅ Done |
| 5 | Add end-to-end API flow tests | Charlie | ✅ Done |
| 6 | Fix 431 response handling for long URLs | Charlie | ✅ Done |

---

## New E2E Tests Added

| Test Name | Description |
|-----------|-------------|
| `TestE2E_CreateGetClaimFlow` | Complete happy path: create → get → claim → verify |
| `TestE2E_MultipleClaimsFlow` | 5 users claim successfully, 6th fails |
| `TestE2E_DoubleDipPrevention` | Same user cannot claim twice (409 Conflict) |
| `TestE2E_ConcurrentClaimsFlow` | 50 concurrent claims, exactly 10 succeed |
| `TestE2E_NonExistentCoupon` | 404 error handling for missing coupons |
| `TestE2E_ValidationErrors` | Input validation (missing name, zero amount, etc.) |

---

## CI Pipeline Final State

```
┌─────────────────────────────────────────────────────────┐
│                    BUILD (parallel)                      │
│                 Provides quick feedback                  │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│              STAGE 1: Quality Gates (parallel)           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │ Unit Tests  │ │    Lint     │ │  Security   │        │
│  │ & Coverage  │ │             │ │             │        │
│  └─────────────┘ └─────────────┘ └─────────────┘        │
│         ~37s           ~25s           ~54s               │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼ (all must pass)
┌─────────────────────────────────────────────────────────┐
│         STAGE 2: Docker Compose Tests (parallel)         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐        │
│  │ Integration │ │   Stress    │ │    Chaos    │        │
│  │   + E2E     │ │             │ │             │        │
│  └─────────────┘ └─────────────┘ └─────────────┘        │
│        ~1m25s         ~1m11s          ~1m26s             │
└─────────────────────────────────────────────────────────┘
```

---

## Previous Retrospective Action Items (Epic 5)

| # | Action Item | Status |
|---|-------------|--------|
| 1 | Go version locked at 1.25.5 | ✅ Completed |
| 2 | Research tool migrations before implementing | ✅ Completed |
| 3 | Continue adversarial code review pattern | ✅ Completed |
| 4 | Commit incrementally after each story | ✅ Completed |
| 5 | All 5 action items from Epic 4 | ✅ Completed |

---

## Lessons Learned

1. **Test Architecture Matters**: In-process testing (`app.Test()`) is faster but doesn't test the full HTTP stack. Real HTTP testing via `net/http` is more realistic.

2. **Docker Compose V2**: GitHub Actions uses `docker compose` (V2) not `docker-compose` (V1). Always use V2 syntax in CI.

3. **URL Length Limits**: Real HTTP servers have URL/header length limits. Tests with very long URLs may get 431 instead of expected responses.

4. **Code Review Catches Critical Issues**: Multiple stories had issues caught by adversarial code review (untracked files, incorrect dependencies, reimplemented stdlib).

---

## Epic 7 Preview

**Epic 7: CI/CD Enhancements & Visibility** (4 stories)
1. Codecov Integration - Dynamic coverage badges
2. Test Category Badges - Separate badges for unit/integration/stress/chaos
3. Go Version Documentation Update - Update docs to show Go 1.25+
4. Version Consistency Check - CI step to verify version matches

**Dependencies**: All Epic 6 work is complete. CODECOV_TOKEN already configured.

---

## Team Agreements for Epic 7

1. ✅ Continue adversarial code review pattern
2. ✅ All `/tests/` must use real HTTP endpoints (enforced by build tags)
3. ✅ Commit incrementally after each story
4. ✅ Use `docker compose` (V2) in all CI workflows

---

*Retrospective completed: 2026-01-12*
